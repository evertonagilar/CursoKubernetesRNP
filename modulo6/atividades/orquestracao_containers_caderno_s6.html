<!DOCTYPE html>
<html lang="pt_BR">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Sessão 6: Segurança no Kubernetes</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Índice</div>
<ul class="sectlevel1">
<li><a href="#_sessão_6_segurança_no_kubernetes">Sessão 6: Segurança no Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_1_visualizando_certificados_digitais">1) Visualizando certificados digitais</a></li>
<li><a href="#_2_api_de_certificados">2) API de certificados</a></li>
<li><a href="#_3_kubeconfig">3) KubeConfig</a></li>
<li><a href="#_4_controle_de_acesso_baseado_em_papéis">4) Controle de acesso baseado em papéis</a></li>
<li><a href="#_5_papéis_cluster_wide">5) Papéis <em>cluster-wide</em></a></li>
<li><a href="#_6_segurança_de_imagens">6) Segurança de imagens</a></li>
<li><a href="#_6_1_deployment_de_registry_privado">6.1) Deployment de <em>registry</em> privado</a></li>
<li><a href="#_6_2_fazendo_o_upload_de_imagens_para_um_registry_privado">6.2) Fazendo o upload de imagens para um <em>registry</em> privado</a></li>
<li><a href="#_6_3_utilizando_um_registry_privado">6.3) Utilizando um <em>registry</em> privado</a></li>
<li><a href="#_7_contextos_de_segurança">7) Contextos de segurança</a></li>
<li><a href="#_7_1_alterando_usuário_e_grupo_efetivos">7.1) Alterando usuário e grupo efetivos</a></li>
<li><a href="#_7_2_habilitando_capabilities">7.2) Habilitando <em>capabilities</em></a></li>
<li><a href="#_8_políticas_de_rede">8) Políticas de rede</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="paragraph">
<p><span class="image"><img src="./img/logoRNP.png" alt="logoRNP" width="150" height="60"></span></p>
</div>
<div class="sect1">
<h2 id="_sessão_6_segurança_no_kubernetes">Sessão 6: Segurança no Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_visualizando_certificados_digitais">1) Visualizando certificados digitais</h3>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Remova os objetos criados na atividade anterior com os comandos que se seguem.</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete pod,rs,deploy,hpa --all</strong></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete svc -l provider!=kubernetes</strong></pre>
</div>
</div>
</li>
<li>
<p>Qual o certificado x509 padrão utilizado pelo <code>kube-apiserver</code> para servir requisições HTTPS? E qual a chave privada correspondente?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Ambas as informações constam no comando de invocação do <code>kube-apiserver</code>. Este pode ser visto de duas formas: primeiro, descrevendo o pod:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod kube-apiserver-s2-master-1 | grep 'tls-cert-file'</strong>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</pre>
</div>
</div>
<div class="paragraph">
<p>Ou, segundo, visualizando o arquivo de definição do pod estático:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep 'tls-private-key-file'</strong>
    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Agora, identifique o certificado, chave privada e certificado de CA (<em>Certificate Authority</em>, ou autoridade certificadora) usados para autenticar o <code>kube-apiserver</code> como um cliente do servidor <code>etcd</code>.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>De igual forma, basta consultar as opções de invocação do <code>kube-apiserver</code>, pesquisando pelas entradas relevantes.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod kube-apiserver-s2-master-1 | grep 'etcd'</strong>
      --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
      --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
      --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
      --etcd-servers=https://127.0.0.1:2379</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Aponte o par de chaves pública/privada utilizadas para autenticar o <code>kube-apiserver</code> junto aos <code>kubelets</code> dos diversos <em>nodes</em> do <em>cluster</em>.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Novamente, é bastante simples obter a informação solicitada:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod kube-apiserver-s2-master-1 | grep 'kubelet-client'</strong>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Já descobrimos quais os certificados e chaves usados para autenticar o <code>kube-apiserver</code> como um cliente do servidor <code>etcd</code>.</p>
<div class="paragraph">
<p>Agora, indique o certificado, chave privada e CA utilizados <strong>pelo</strong> servidor <code>etcd</code> para disponibilizar seus serviços a clientes (como o <code>kube-apiserver</code>, por exemplo).</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>As informações solicitadas encontram-se entre as opções de invocação do <em>daemon</em> <code>etcd</code> dentro do pod <code>etcd-s2-master-1</code>. Vamos visualizá-las, uma a uma:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod etcd-s2-master-1 | grep '\-\-cert-file='</strong>
      --cert-file=/etc/kubernetes/pki/etcd/server.crt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod etcd-s2-master-1 | grep '\-\-key-file='</strong>
      --key-file=/etc/kubernetes/pki/etcd/server.key</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod etcd-s2-master-1 | grep '\-\-trusted-ca-file='</strong>
      --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Vamos agora investigar detalhes sobre esses certificados. Indique, para o certificado usado pelo <code>kube-apiserver</code>, as seguintes informações:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Common Name</em> (CN)</p>
</li>
<li>
<p>CA emissora</p>
</li>
<li>
<p>Algoritmo utilizado e tamanho da chave</p>
</li>
<li>
<p>Nomes alternativos configurados para o serviço</p>
</li>
<li>
<p>Validade do certificado (início e final)</p>
</li>
</ul>
</div>
</div>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Podemos visualizar informações sobre um certificado no terminal usando o comando <code>openssl x509</code>. Em conjunção com o <code>grep</code>, é trivial selecionar apenas os campos objetivados por cada um dos itens da lista acima. Primeiro, vejamos o CN:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep 'Subject: CN'</strong>
        Subject: CN = kube-apiserver</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, o <em>issuer</em> (ou CA emissora), que também possui a <em>string</em> CN em sua linha:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep 'Issuer: CN'</strong>
        Issuer: CN = kubernetes</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, o algoritmo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep 'Signature Algorithm' | sed 's/^[[:space:]]&#42;//g' | uniq</strong>
Signature Algorithm: sha256WithRSAEncryption</pre>
</div>
</div>
<div class="paragraph">
<p>O tamanho da chave fica destacado na linha <code>RSA Public-Key</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep 'RSA Public-Key'</strong>
                RSA Public-Key: (2048 bit)</pre>
</div>
</div>
<div class="paragraph">
<p>E quanto aos nomes alternativos do serviço? Vejamos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep 'Alternative Name' -A1</strong>
            X509v3 Subject Alternative Name:
                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:s2-master-1, IP Address:10.96.0.1, IP Address:192.168.68.20</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos à validade:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep 'Validity' -A2</strong>
        Validity
            Not Before: May  3 03:54:58 2023 GMT
            Not After : May  2 03:54:58 2024 GMT</pre>
</div>
</div>
<div class="paragraph">
<p>Note que a validade do certificado é de um ano, fato confirmado ao consultarmos a data e hora correntes no servidor.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># date</strong>
Fri 05 May 2023 02:19:40 AM UTC</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Compare a validade do certificado analisado no passo anterior com o da CA utilizada para autenticar clientes do <code>kube-apiserver</code>. Há alguma diferença?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiro, vamos descobrir qual é esse certificado:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod kube-apiserver-s2-master-1 | grep '\-\-client-ca-file'</strong>
      --client-ca-file=/etc/kubernetes/pki/ca.crt</pre>
</div>
</div>
<div class="paragraph">
<p>Ao verificar sua validade, constatamos que ela é significativamente superior: dez anos!</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl x509 -in /etc/kubernetes/pki/ca.crt -text -noout | grep 'Validity' -A2</strong>
        Validity
            Not Before: May  3 03:54:58 2023 GMT
            Not After : Apr 30 03:54:58 2033 GMT</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Antes de prosseguir, execute o comando abaixo:</p>
<div class="literalblock">
<div class="content">
<pre><strong># lab-6.1.1</strong></pre>
</div>
</div>
</li>
<li>
<p>Tente executar qualquer comando <code>kubectl</code>. O que ocorre?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vejamos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get pod</strong>
The connection to the server 192.168.68.20:6443 was refused - did you specify the right host or port?</pre>
</div>
</div>
<div class="paragraph">
<p>Não funcionou&#8230;&#8203; por que será?</p>
</div>
</div>
</details>
</li>
<li>
<p>Aparentemente, o problema está afetando o pod <code>kube-apiserver</code>. Investigue sua causa-raiz e solucione-o.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Note que, ao tentarmos visualizarmos eventos do pod via <code>kubectl</code>, encontramos um erro. Da mesma forma que no passo anterior, a indisponibilidade do <code>kube-apiserver</code> impede que tomemos o caminho típico para solucionar esse problema.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod kube-apiserver-s2-master-1</strong>
The connection to the server 192.168.68.20:6443 was refused - did you specify the right host or port?</pre>
</div>
</div>
<div class="paragraph">
<p>E agora? Bem, sabemos que o <code>kube-apiserver</code> é um pod estático operando dentro do <em>node</em> <code>s2-master-1</code>. Adicionalmente, sabemos que o <em>container runtime</em> utilizado para executar os containers em nossa instalação do Kubernetes é o Docker.</p>
</div>
<div class="paragraph">
<p>Podemos, então, consultar diretamente os logs do container via comando <code>docker</code>. Para tanto, vamos primeiramente descobrir seu <em>container ID</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># docker ps -a | grep kube-apiserver</strong>
5e86c83397f2        607331163122            "kube-apiserver --ad…"   About a minute ago   Exited (1) 39 seconds ago                        k8s_kube-apiserver_kube-apiserver-s2-master-1_kube-system_385b165efbf056419463126763d02159_3
4d5b810938d9        k8s.gcr.io/pause:3.2    "/pause"                 2 minutes ago        Up 2 minutes                                     k8s_POD_kube-apiserver-s2-master-1_kube-system_385b165efbf056419463126763d02159_0</pre>
</div>
</div>
<div class="paragraph">
<p>De posse deste, vamos visualizar seus eventos com o comando <code>docker logs</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># docker logs 5e86c83397f2 --tail 10</strong>
W0505 02:21:20.871033       1 logging.go:59] [core] [Channel #3 SubChannel #4] grpc: addrConn.createTransport failed to connect to {
  "Addr": "127.0.0.1:2379",
  "ServerName": "127.0.0.1",
  "Attributes": null,
  "BalancerAttributes": null,
  "Type": 0,
  "Metadata": null
}. Err: connection error: desc = "transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate signed by unknown authority"</pre>
</div>
</div>
<div class="paragraph">
<p>Uhm&#8230;&#8203; o certificado apresentado ao <code>kube-apiserver</code> quando ele se conecta com o serviço na porta 2379 é assinado por uma autoridade certificadora desconhecida. Caso você não se recorde, esse serviço é o <code>etcd</code>. Vamos ver como está a configuração de certificados do <code>kube-apiserver</code>&#8201;&#8212;&#8201;especificamente o que define a CA do <code>etcd</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd-cafile</strong>
    - --etcd-cafile=/etc/kubernetes/pki/ca.crt</pre>
</div>
</div>
<div class="paragraph">
<p>No passo (e) desta atividade observamos que o certificado da CA do <code>etcd</code> é definido pela opção <code>trusted-ca-file</code>. Naquela ocasião, seu valor era <code>/etc/kubernetes/pki/etcd/ca.crt</code>, diferente do utilizado acima. Vamos alterá-lo com o comando <code>sed</code>, modificando o arquivo YAML que define o pod estático <code>kube-apiserver</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># sed -i 's/\(etcd-cafile=\).&#42;/\1\/etc\/kubernetes\/pki\/etcd\/ca.crt/' /etc/kubernetes/manifests/kube-apiserver.yaml</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Após algum tempo, o pod estático do <code>kube-apiserver</code> volta a ficar operacional. Evidentemente, o comando <code>kubectl</code> também fica disponível&#8201;&#8212;&#8201;veja:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system get pod kube-apiserver-s2-master-1</strong>
NAME                         READY   STATUS    RESTARTS   AGE
kube-apiserver-s2-master-1   1/1     Running   0          24s</pre>
</div>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_api_de_certificados">2) API de certificados</h3>
<div class="sect3">
<h4 id="_2_1_criando_novos_usuários">2.1) Criando novos usuários</h4>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Um novo colaborador, <code>mario</code>, foi adicionado à equipe; vamos conceder acesso no <em>cluster</em> Kubernetes a esse usuário.</p>
<div class="paragraph">
<p>O primeiro passo, evidentemente, é criar sua chave privada e CSR (<em>Certificate Signing Request</em>). Faça isso utilizando o comando <code>openssl</code>, gerando uma chave RSA de 2048 bits.</p>
</div>
<div class="paragraph">
<p>Ao gerar o CSR serão feitas algumas perguntas. Responda-as da seguinte forma:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Country Name</em>: <code>BR</code></p>
</li>
<li>
<p><em>State or Province Name</em>: Código de 2 letras do seu estado (p.ex. <code>DF</code>)</p>
</li>
<li>
<p><em>Locality Name</em>: Sua cidade</p>
</li>
<li>
<p><em>Organization Name</em>: <code>Contorq</code></p>
</li>
<li>
<p><em>Organizational Unit Name</em>: <code>IT</code></p>
</li>
<li>
<p><em>Common Name</em>: <code>mario</code></p>
</li>
<li>
<p><em>Email Address</em>: <code>mario@contorq.com</code></p>
</li>
<li>
<p><em>A challenge password</em>: deixe vazio</p>
</li>
<li>
<p><em>An optional company name</em>: deixe vazio</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Verifique que ambos os arquivos foram criados com sucesso.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos começar gerando a chave privada do usuário:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl genrsa -out mario.key 2048</strong>
Generating RSA private key, 2048 bit long modulus (2 primes)
...........................++
...................................................................................++
e is 65537 (0x010001)</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, criamos seu CSR (<em>Certificate Signing Request</em>). Nas perguntas, basta digitar as informações providas no enunciado da atividade.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># openssl req -new -key mario.key -out mario.csr</strong>
You are about to be asked to enter information that will be incorporated
into your certificate request.

(...)

A challenge password []:
An optional company name []:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># ls mario.&#42;</strong>
mario.csr  mario.key</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Crie um objeto do tipo CertificateSigningRequest usando o CSR criado no passo anterior. Comece pelo arquivo YAML, e em seguida adicione-o ao sistema via <code>kubectl create</code>.</p>
<div class="paragraph">
<p>Verifique o funcionamento de sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>O arquivo YAML que descreve esse objeto é bastante simples. Como não foram solicitadas permissões adicionais ao usuário iremos manter apenas o grupo padrão, <code>system:authenticated</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">certificates.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CertificateSigningRequest</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mario</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">system:authenticated</span>
  <span class="na">request</span><span class="pi">:</span> <span class="s">MARIO_CSR_BASE64</span>
  <span class="na">signerName</span><span class="pi">:</span> <span class="s">kubernetes.io/kube-apiserver-client</span>
  <span class="na">usages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">client auth</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Veja que o atributo <code>request</code>, acima, não está preenchido. Ele deve conter o CSR do usuário a ser adicionado, codificado em base64. Vamos fazer a codificação e substituição com o comando abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># sed -i "s/MARIO_CSR_BASE64/$( cat mario.csr | base64 | tr -d '\n' )/" mario_csr.yaml</strong></pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, criamos o objeto com <code>kubectl create</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create -f mario_csr.yaml</strong>
certificatesigningrequest.certificates.k8s.io/mario created</pre>
</div>
</div>
<div class="paragraph">
<p>Terá funcionado? Vamos ver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get csr mario</strong>
NAME    AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION
mario   4s    kubernetes.io/kube-apiserver-client   kubernetes-admin   &lt;none&gt;              Pending</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Note que o CSR não é aprovado automaticamente. Faça isso.</p>
<div class="paragraph">
<p>Em seguida, imprima na tela o certificado assinado, que deve ser repassado ao usuário <code>mario</code>&#8201;&#8212;&#8201;este, juntamente com a chave privada, serão os recursos utilizados pelo usuário para autenticar-se no <em>cluster</em>.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A aprovação do certificado é bastante simples, via comando <code>kubectl certificate</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl certificate approve mario</strong>
certificatesigningrequest.certificates.k8s.io/mario approved</pre>
</div>
</div>
<div class="paragraph">
<p>Para obter o certificado basta solicitar o objeto em formato YAML; o atributo <code>certificate</code> contém a informação que procuramos.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get csr/mario -o yaml | grep '^ *certificate:'</strong>
  certificate: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURRVENDQWltZ0F3SUJBZ0lRUzVOMmxyUVZreWVXZGpFNXoyTGtNREFOQmdrcWhraUc5dzBCQVFzRkFEQVYKTVJNd0VRWURWUVFERXdwcmRXSmxjbTVsZEdWek1CNFhEVEl3TVRBd056QTVOVEV6TTFvWERUSXhNVEF3TnpBNQpOVEV6TTFvd1hERUxNQWtHQTFVRUJoTUNRbEl4Q3pBSkJnTlZCQWdUQWtSR01SRXdEd1lEVlFRSEV3aENjbUZ6CmFXeHBZVEVRTUE0R0ExVUVDaE1IUTI5dWRHOXljVEVMTUFrR0ExVUVDeE1DU1ZReERqQU1CZ05WQkFNVEJXUmgKZG1sa01JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBdTlvZ1BjVUFoRW1UczBTZApPK1dGNzd5dUlYWERERVJteEFKc1lDTHhYdzhCWlR0ZXV1VGlFSEthdFlXQm1aUGNVNTcyUE9EOXlYclVObWZLCi9PM2N5TjNaMXRjQ2RFL2IxOEZCa0YwU3BFcTY2UlZSaVdhejBKejdvVnl1QUlqTGZ0b3E3U1FLVEV1cnhuYjIKWTdsaEI2UURMM0M4b3NRQVFxdWpNZUVMajNiSlZuTndGSzBkUnR6SkZoK1Rmbm1BYXo0Tk9wVTdPUUMxTlRyYQpWaHZDTjdTTjFNRi8vR0N2dGczd0NFcndLYjVXRXpTL09Tc3J5eUdidXVJMDVTbmV2eE9TbTBzZW16V1M3MmpWCkpJMzVTdE1ZL1o4UExsUXN2clNUS09Ua2Rvd1hRWk5Ma2g4aUo1NERCdlU1YW5IcVhYQ0lBZUZyQWlGZmx3SjAKMDRXNmx3SURBUUFCbzBZd1JEQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBakFNQmdOVkhSTUJBZjhFQWpBQQpNQjhHQTFVZEl3UVlNQmFBRkxMT1RySlk4b1loNUtvb0psMnp1d2RXU2VxOE1BMEdDU3FHU0liM0RRRUJDd1VBCkE0SUJBUUFSTTNRZVNJNFdSckJBNWhtUklvRVV2blFqRlQ5dVZwcS9TVzhkNU1UOVVDTUN6UXZwTTh4c0JQMk4KZkI0U0VQQk1uUUpCVzZiakN6Mmo5ZEpCZnJneWlzRVhqUXplMlpscE5UVlhvNGViZGRBb0daTmF0dkF5MWxIMgpOWmpCWDRlTUR4dHB3Zlh3dTQzcE42UW52ZmE0VEgrbmtCSjcvTHZ0cUJKTVYzUzdWNDNGUURhREZ5UjY0WXBtCjVxRDZSZG9hS1J0d1o4amkzdVhvYTFQa3UwNDVLb0VDbmhRd202RDZ6aktMTjJXODlhWGJiMXl0dm5GUGxBRS8KOXp3RE16Uno1UXRIdEJtS0VJaGV4bzBaYWM1cE5MZzkwM3phd0wzNllRZFlIODArMUFyUGJEWnNyWkMrTnNsVwpTOEZVZ2loUkNyU2xLa1h4Y1QzT1A2RWRUSm5JCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</pre>
</div>
</div>
<div class="paragraph">
<p>Note que o certificado acima está codificado em <code>base64</code>&#8201;&#8212;&#8201;para utilizá-lo, é necessário primeiro realizar o <em>decode</em> dessa <em>string</em>.</p>
</div>
</div>
</details>
</li>
<li>
<p>Crie, se não existir, a pasta <code>/root/.kube/users</code>. A seguir, copie para dentro dessa pasta a chave privada e o certificado assinado do usuário <code>mario</code>, utilizando os nomes de arquivo <code>mario.key</code> e <code>mario.crt</code>, respectivamente.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos primeiramente criar a pasta:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># mkdir -p /root/.kube/users</strong></pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, copiamos a chave privada para a pasta.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># mv /root/mario.key /root/.kube/users</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Iremos usar um comando semelhante ao utilizado na atividade anterior para extrair o certificado assinado&#8201;&#8212;&#8201;desta vez, contudo, iremos usar o comando <code>base64</code> para decodificar a <em>string</em> e redirecionar o resultado para o arquivo <code>mario.crt</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get csr/mario -o jsonpath='{.status.certificate}' | base64 -d > /root/.kube/users/mario.crt</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Vejamos se tudo funcionou a contento:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># ls -1 /root/.kube/users/</strong>
mario.crt
mario.key</pre>
</div>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_2_2_detectando_inconsistências">2.2) Detectando inconsistências</h4>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Antes de prosseguir, execute o comando abaixo:</p>
<div class="literalblock">
<div class="content">
<pre><strong># lab-6.2.2</strong></pre>
</div>
</div>
</li>
<li>
<p>Um novo CSR foi adicionado. Qual é ele?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vejamos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get csr | grep 'Pending'</strong>
bowser   5s    kubernetes.io/kube-apiserver-client   kubernetes-admin   &lt;none&gt;              Pending</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Que estranho, não adicionamos nenhum CSR com esse nome até aqui&#8230;&#8203; verifique a quais grupos esse CSR solicita acesso.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Visualize o CSR em formato YAML, buscando o atributo <code>groups</code>. Assim:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get csr bowser -o yaml | grep '^ *groups:' -A2</strong>
  groups:
  - system:masters
  - system:authenticated</pre>
</div>
</div>
<div class="paragraph">
<p>Note que além do grupo padrão <code>system:authenticated</code>, o usuário também seria adicionado a <code>system:masters</code>: esse grupo efetivamente possui permissões totais sobre o <em>cluster</em>.</p>
</div>
</div>
</details>
</li>
<li>
<p>Perigoso, não é mesmo? Caso esse CSR fosse aprovado, o usuário em questão poderia ter acesso irrestrito ao <em>cluster</em>. Negue a solicitação, e em seguida remova o CSR.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiro, negamos a solicitação:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl certificate deny bowser</strong>
certificatesigningrequest.certificates.k8s.io/bowser denied</pre>
</div>
</div>
<div class="paragraph">
<p>E, depois, removemos o CSR:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete csr bowser</strong>
certificatesigningrequest.certificates.k8s.io "bowser" deleted</pre>
</div>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_kubeconfig">3) KubeConfig</h3>
<div class="sect3">
<h4 id="_3_1_lidando_com_arquivos_kubeconfig_simples">3.1) Lidando com arquivos KubeConfig simples</h4>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Há três diferentes modos de definição do arquivo <code>kubeconfig</code> a ser utilizado em um comando <code>kubectl</code>. Quais são eles?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Segundo a documentação do Kubernetes, disponível em <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" class="bare">https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/</a> , as três formas são:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Arquivo com o nome <code>config</code>, dentro do diretório <code>$HOME/.kube</code> do usuário.</p>
</li>
<li>
<p>Arquivo apontado pela variável de ambiente <code>$KUBECONFIG</code> no <em>shell</em> corrente.</p>
</li>
<li>
<p>Arquivo especificado diretamente através da <em>flag</em> <code>--kubeconfig</code> passada ao comando <code>kubectl</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Considere o arquivo <code>kubeconfig</code> sendo utilizado no momento, pelo usuário <code>root</code>. Quantos <em>clusters</em>, usuários e contextos estão definidos nesse arquivo, e quais são eles? Qual é o contexto padrão configurado?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos ver se o arquivo <code>kubeconfig</code> padrão, descrito pelo item (1) da resposta ao passo anterior, existe.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># ls -d ${HOME}/.kube/config</strong>
/root/.kube/config</pre>
</div>
</div>
<div class="paragraph">
<p>Poderíamos visualizar as informações solicitadas diretamente no arquivo, e contar "no olho". Mas, muito melhor, podemos utilizar uma ferramenta de <em>parsing</em> especializada em arquivos YAML, como é o caso da <code>yq</code>. Instale-a:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># wget https://github.com/mikefarah/yq/releases/download/v4.33.3/yq_linux_amd64 -O /usr/bin/yq && chmod +x /usr/bin/yq</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Para utilizar o <code>yq</code>, basta invocá-lo com o parâmetro <code>read</code>, ou <code>r</code>, juntamente com a <em>string</em> de busca. Por exemplo, vamos solicitar os nomes de todos os <em>clusters</em> existentes no arquivo, e em seguida contar o número de linhas&#8201;&#8212;&#8201;efetivamente, respondendo à pergunta de quantos <em>clusters</em> estão definidos.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.clusters[].name' /root/.kube/config | wc -l</strong>
1</pre>
</div>
</div>
<div class="paragraph">
<p>Removendo o <code>wc</code> podemos visualizar os nomes desses <em>clusters</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.clusters[].name' /root/.kube/config</strong>
kubernetes</pre>
</div>
</div>
<div class="paragraph">
<p>Qual será o endereço do servidor desse <em>cluster</em>?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.clusters[].cluster.server' /root/.kube/config</strong>
<a href="https://192.168.68.20:6443" class="bare">https://192.168.68.20:6443</a></pre>
</div>
</div>
<div class="paragraph">
<p>Façamos o mesmo procedimento para contar o número, e definir quais são, os usuários definidos no <code>kubeconfig</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[].name' /root/.kube/config | wc -l</strong>
1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[].name' /root/.kube/config</strong>
kubernetes-admin</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, vejamos as informações dos contextos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.contexts[].name' /root/.kube/config | wc -l</strong>
1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.contexts[].name' /root/.kube/config</strong>
kubernetes-admin@kubernetes</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.contexts[].context' /root/.kube/config</strong>
cluster: kubernetes
user: kubernetes-admin</pre>
</div>
</div>
<div class="paragraph">
<p>O <code>current-context</code> define o contexto padrão ao utilizar o <code>kubeconfig</code> em questão. Para visualizá-lo, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.current-context' /root/.kube/config</strong>
kubernetes-admin@kubernetes</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Vamos retomar a configuração do usuário <code>mario</code>, iniciada na atividade (2).</p>
<div class="paragraph">
<p>Adicione as credenciais (chave privada e certificado assinado) desse usuário ao arquivo <code>/root/.kube/config</code>. A seguir, adicione um novo contexto, <code>mario@kubernetes</code>, relacionando esse usuário ao <em>cluster</em> <code>kubernetes</code> (sugestão: utilize o comando <code>kubectl config</code>).</p>
</div>
<div class="paragraph">
<p>Finalmente, altere o contexto padrão para o recém-criado <code>mario@kubernetes</code> e verifique seu funcionamento com um comando <code>kubectl</code> qualquer. Note que, como ainda não atribuímos permissões a esse usuário, você verá um erro: <strong>isso é esperado</strong>, e será corrigido na próxima atividade.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Podemos adicionar as credenciais manualmente ou, muito melhor, fazê-lo automaticamente com o comando <code>kubectl config set-credentials</code>. Para tanto, basta apontar os arquivos de certificado e chave com as <em>flags</em> apropriadas:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl config set-credentials mario --client-key=/root/.kube/users/mario.key --client-certificate=/root/.kube/users/mario.crt --embed-certs=true</strong>
User "mario" set.</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos validar se o comando funcionou usando o <code>yq</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[].name' /root/.kube/config</strong>
kubernetes-admin
mario</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, criamos um contexto para o novo usuário com o <em>cluster</em> preexistente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl config set-context mario@kubernetes --cluster=kubernetes --user=mario</strong>
Context "mario@kubernetes" created.</pre>
</div>
</div>
<div class="paragraph">
<p>Terá funcionado?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.contexts[].name' /root/.kube/config</strong>
kubernetes-admin@kubernetes
mario@kubernetes</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito. Vamos agora alterar o contexto padrão&#8201;&#8212;&#8201;primeiro, verificando seu valor atual.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.current-context' /root/.kube/config</strong>
kubernetes-admin@kubernetes</pre>
</div>
</div>
<div class="paragraph">
<p>Alterando-o:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl config use-context mario@kubernetes</strong>
Switched to context "mario@kubernetes".</pre>
</div>
</div>
<div class="paragraph">
<p>E validando o funcionamento da configuração:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.current-context' /root/.kube/config</strong>
mario@kubernetes</pre>
</div>
</div>
<div class="paragraph">
<p>Ao tentar interagir com o <em>cluster</em>, obtemos o erro aludido pelo enunciado.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get pod</strong>
Error from server (Forbidden): pods is forbidden: User "mario" cannot list resource "pods" in API group "" in the namespace "default"</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Finalmente, retorne ao contexto anterior com o comando:</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl config use-context kubernetes-admin@kubernetes</strong>
Switched to context "kubernetes-admin@kubernetes".</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_3_2_lidando_com_arquivos_kubeconfig_complexos">3.2) Lidando com arquivos KubeConfig complexos</h4>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Antes de prosseguir, execute o comando abaixo:</p>
<div class="literalblock">
<div class="content">
<pre><strong># lab-6.3.2</strong></pre>
</div>
</div>
</li>
<li>
<p>Vamos agora considerar um arquivo <code>kubeconfig</code> mais complexo, acessível em <code>/root/custom-kubeconfig</code>. Quantos <em>clusters</em>, usuários e contextos estão definidos nesse arquivo, e quais são eles?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Usando o <code>yq</code>, é trivial responder as perguntas realizadas. Primeiro, as informações de <em>clusters</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.clusters[].name' /root/custom-kubeconfig | wc -l</strong>
3</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.clusters[].name' /root/custom-kubeconfig</strong>
bloodsport
diehard
predator</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, de usuários:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[].name' /root/custom-kubeconfig | wc -l</strong>
3</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[].name' /root/custom-kubeconfig</strong>
dutch
dux
mcclane</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, de contextos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.contexts[].name' /root/custom-kubeconfig | wc -l</strong>
3</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.contexts[].name' /root/custom-kubeconfig</strong>
dutch@predator
dux@bloodsport
mcclane@diehard</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Quais são os arquivos de certificado e chave privada utilizados pelo usuário <code>mcclane</code>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Essas informações podem ser visualizadas na seção <code>users.user</code> do usuário em questão. Iremos referenciá-lo pelo índice do usuário, com a ferramenta <code>yq</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[2].user.client-certificate' /root/custom-kubeconfig</strong>
/etc/kubernetes/pki/users/mcclane.cert</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.users[2].user.client-key' /root/custom-kubeconfig</strong>
/etc/kubernetes/pki/users/mcclane.key</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Qual é o contexto padrão configurado? Se necessário, altere-o para que esse contexto seja <code>mcclane@diehard</code>.</p>
<div class="paragraph">
<p>Verifique o funcionamento de sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vejamos o contexto padrão:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.current-context' /root/custom-kubeconfig</strong>
dutch@predator</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, alteramos o contexto e verificamos a efetivação da configuração.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl config use-context mcclane@diehard --kubeconfig=/root/custom-kubeconfig</strong>
Switched to context "mcclane@diehard".</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># yq '.current-context' /root/custom-kubeconfig</strong>
mcclane@diehard</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Ter que especificar a <em>flag</em> <code>--kubeconfig</code> a cada comando <code>kubectl</code> utilizado é bastante inconveniente. Faça com que o arquivo <code>kubeconfig</code> <code>/root/custom-kubeconfig</code> seja utilizado como o <code>kubeconfig</code> padrão <strong>apenas</strong> na sessão corrente do <em>shell</em>.</p>
<div class="paragraph">
<p>Não sobrescreva o arquivo <code>/root/.kube/config</code> existente.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Além de utilizar a <em>flag</em> <code>--kubeconfig</code> e via arquivo <code>$HOME/.kube/config</code>, é também possível definir o arquivo <code>kubeconfig</code> a ser utilizado através da variável de ambiente <code>$KUBECONFIG</code>. Defina-a:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># export KUBECONFIG=/root/custom-kubeconfig</strong></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Ao tentar utilizar qualquer comando <code>kubectl</code> para interagir com o <em>cluster</em>, um erro é encontrado. Qual é ele?</p>
<div class="paragraph">
<p>Determine sua razão, e solucione o problema.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos ver qual é esse erro:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get pod</strong>
error: unable to read client-cert /etc/kubernetes/pki/users/mcclane.cert for mcclane due to open /etc/kubernetes/pki/users/mcclane.cert: no such file or directory</pre>
</div>
</div>
<div class="paragraph">
<p>O arquivo <code>/etc/kubernetes/pki/users/mcclane.cert</code> não foi encontrado. Quais arquivos existem nesse diretório?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># ls -1 /etc/kubernetes/pki/users/mcclane.&#42;</strong>
/etc/kubernetes/pki/users/mcclane.crt
/etc/kubernetes/pki/users/mcclane.key</pre>
</div>
</div>
<div class="paragraph">
<p>Note que o nome correto do arquivo é <code>mcclane.crt</code>, e não <code>mcclane.cert</code>. Vamos corrigir a informação via <code>sed</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># sed -i 's/mcclane.cert/mcclane.crt/' /root/custom-kubeconfig</strong></pre>
</div>
</div>
<div class="paragraph">
<p>E, em seguida, testar o funcionamento do comando <code>kubectl</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get node</strong>
NAME          STATUS   ROLES           AGE   VERSION
s2-master-1   Ready    control-plane   46h   v1.27.1
s2-node-1     Ready    &lt;none&gt;          46h   v1.27.1</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Finalmente, volte a utilizar o arquivo <code>kubeconfig</code> padrão com o comando:</p>
<div class="literalblock">
<div class="content">
<pre><strong># unset KUBECONFIG</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Valide o funcionamento de sua configuração com o comando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get node</strong>
NAME          STATUS   ROLES           AGE   VERSION
s2-master-1   Ready    control-plane   46h   v1.27.1
s2-node-1     Ready    &lt;none&gt;          46h   v1.27.1</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Aviso"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para facilitar a alternância de contextos, usuários e <em>namespaces</em> usando o <code>kubectl</code> é comum utilizarmos ferramentas ou <em>scripts</em> que tornem o processo mais ágil. Uma excelente alternativa são as ferramentas <code>kubectx</code> e <code>kubens</code>, disponíveis em <a href="https://github.com/ahmetb/kubectx" class="bare">https://github.com/ahmetb/kubectx</a>. Não deixe de conferir!</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_controle_de_acesso_baseado_em_papéis">4) Controle de acesso baseado em papéis</h3>
<div class="sect3">
<h4 id="_4_1_papéis_padrão_do_sistema">4.1) Papéis-padrão do sistema</h4>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>O Kubernetes suporta diversos métodos de autorização, documentados em <a href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#authorization-modules" class="bare">https://kubernetes.io/docs/reference/access-authn-authz/authorization/#authorization-modules</a> . Quais modos de autorização estão configurados no <em>cluster</em>, no momento?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Essa informação é definida através da opção <code>--authorization-mode</code>, quando da invocação do <code>kube-apiserver</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe pod kube-apiserver-s2-master-1 | grep authorization-mode</strong>
      --authorization-mode=Node,RBAC</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Quais são as <em>roles</em> (papéis) existentes em cada um dos namespaces presentes no <em>cluster</em>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Pode-se utilizar o comando <code>kubectl get role</code>, circulando por cada um dos namespaces e contando os <em>roles</em> existentes em cada um deles. Alternativamente, podemos fazer isso em um único comando, como no formato mostrado abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># for ns in $( kubectl get ns -o custom-columns=NAME:.metadata.name --no-headers ); do echo -e "\nNamespace: ${ns}\n-----\n"; kubectl get role -n ${ns}; done</strong>

Namespace: default
-----

No resources found in default namespace.

Namespace: kube-node-lease
-----

No resources found in kube-node-lease namespace.

Namespace: kube-public
-----

NAME                                   CREATED AT
kubeadm:bootstrap-signer-clusterinfo   2023-05-03T03:55:15Z
system:controller:bootstrap-signer     2023-05-03T03:55:13Z

Namespace: kube-system
-----

NAME                                             CREATED AT
extension-apiserver-authentication-reader        2023-05-03T03:55:13Z
kube-proxy                                       2023-05-03T03:55:15Z
kubeadm:kubelet-config                           2023-05-03T03:55:14Z
kubeadm:nodes-kubeadm-config                     2023-05-03T03:55:14Z
system::leader-locking-kube-controller-manager   2023-05-03T03:55:13Z
system::leader-locking-kube-scheduler            2023-05-03T03:55:13Z
system:controller:bootstrap-signer               2023-05-03T03:55:13Z
system:controller:cloud-provider                 2023-05-03T03:55:13Z
system:controller:token-cleaner                  2023-05-03T03:55:13Z</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Quais recursos, e ações sobre esses recursos, são garantidos à <em>role</em> <code>kube-proxy</code>, no namespace <code>kube-system</code>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Para tanto, basta utilizar <code>kubectl describe</code>. Veja que a <em>role</em> possui permissão de visualizar o ConfigMap <code>kube-proxy</code>, apenas.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe role kube-proxy | grep 'PolicyRule:' -A3</strong>
PolicyRule:
  Resources   Non-Resource URLs  Resource Names  Verbs
  ---------   -----------------  --------------  -----
  configmaps  []                 [kube-proxy]    [get]</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Quais RoleBindings existem em cada um dos namespaces presentes no <em>cluster</em>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Assim como no passo (b), realizamos o mesmo procedimento com os objetos do tipo RoleBinding.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># for ns in $( kubectl get ns -o custom-columns=NAME:.metadata.name --no-headers ); do echo -e "\nNamespace: ${ns}\n-----\n"; kubectl get rolebinding -n ${ns}; done</strong>

Namespace: default
-----

No resources found in default namespace.

Namespace: kube-node-lease
-----

No resources found in kube-node-lease namespace.

Namespace: kube-public
-----

NAME                                   ROLE                                        AGE
kubeadm:bootstrap-signer-clusterinfo   Role/kubeadm:bootstrap-signer-clusterinfo   46h
system:controller:bootstrap-signer     Role/system:controller:bootstrap-signer     46h

Namespace: kube-system
-----

NAME                                                ROLE                                                  AGE
kube-proxy                                          Role/kube-proxy                                       46h
kubeadm:kubelet-config                              Role/kubeadm:kubelet-config                           46h
kubeadm:nodes-kubeadm-config                        Role/kubeadm:nodes-kubeadm-config                     46h
metrics-server-auth-reader                          Role/extension-apiserver-authentication-reader        23h
system::extension-apiserver-authentication-reader   Role/extension-apiserver-authentication-reader        46h
system::leader-locking-kube-controller-manager      Role/system::leader-locking-kube-controller-manager   46h
system::leader-locking-kube-scheduler               Role/system::leader-locking-kube-scheduler            46h
system:controller:bootstrap-signer                  Role/system:controller:bootstrap-signer               46h
system:controller:cloud-provider                    Role/system:controller:cloud-provider                 46h
system:controller:token-cleaner                     Role/system:controller:token-cleaner                  46h</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Qual é a conta associada à <em>role</em> <code>metrics-server-auth-reader</code>, no namespace <code>kube-system</code>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Para determinar esse informação, basta utilizar <code>kubectl describe</code>. Veja que trata-se de uma conta do tipo ServiceAccount.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n kube-system describe rolebinding metrics-server-auth-reader</strong>
Name:         metrics-server-auth-reader
Labels:       k8s-app=metrics-server
Annotations:  &lt;none&gt;
Role:
  Kind:  Role
  Name:  extension-apiserver-authentication-reader
Subjects:
  Kind            Name            Namespace
  ----            ----            ---------
  ServiceAccount  metrics-server  kube-system</pre>
</div>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_4_2_criando_novos_papéis">4.2) Criando novos papéis</h4>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Vamos voltar à configuração do usuário <code>mario</code>. Utilizando o comando <code>kubectl auth</code>, verifique se esse usuário possui permissão para visualizar a lista de pods no namespace <em>default</em>.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>De forma similar ao comando <code>sudo</code>, no <em>shell</em> Bash, pode-se utilizar a <em>flag</em> <code>--as</code> para simular a execução de um comando como outro usuário. Para validar se é possível executar uma ação no <em>cluster</em>, pode-se informar o comando <code>can-i</code> ao <code>kubectl auth</code>. Assim:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl auth can-i list pods --as mario</strong>
no</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Crie a <em>role</em> <code>pod-admin</code>, com permissões de listagem, criação e deleção de pods no namespace <em>default</em>. Visualize-a em detalhes, com <code>kubectl describe</code>.</p>
<div class="paragraph">
<p>Em seguida, crie o RoleBinding <code>pod-admin-mario</code> ligando a <em>role</em> <code>pod-admin</code> ao usuário <code>mario</code>. Visualize-a em detalhes, com <code>kubectl describe</code>.</p>
</div>
<div class="paragraph">
<p>Valide sua configuração através da criação, listagem e subsequente remoção de um pod qualquer no namespace <em>default</em>.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiramente, criaremos a <em>role</em>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create role pod-admin --resource=pods --verb=create,list,delete</strong>
role.rbac.authorization.k8s.io/pod-admin created</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos verificar se os objetos e ações desejados são de fato os afetados pela <em>role</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe role pod-admin</strong>
Name:         pod-admin
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  pods       []                 []              [create list delete]</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito. Vamos agora criar o RoleBinding, associando a <em>role</em> ao usuário <code>mario</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create rolebinding pod-admin-mario --role=pod-admin --user=mario</strong>
rolebinding.rbac.authorization.k8s.io/pod-admin-mario created</pre>
</div>
</div>
<div class="paragraph">
<p>Novamente, verificamos se a ação surtiu o efeito esperado:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe rolebinding pod-admin-mario</strong>
Name:         pod-admin-mario
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  Role
  Name:  pod-admin
Subjects:
  Kind  Name   Namespace
  ----  ----   ---------
  User  mario</pre>
</div>
</div>
<div class="paragraph">
<p>Retomemos o uso do comando <code>kubectl auth can-i</code>. Como ficou o permissionamento do usuário?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl auth can-i list pods --as mario</strong>
yes</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, o usuário <code>mario</code> deve ter permissão de listar, criar e deletar pods. Testemos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl run test --image=nginx:alpine --as=mario</strong>
pod/test created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get pod --as=mario</strong>
NAME   READY   STATUS    RESTARTS   AGE
test   1/1     Running   0          26s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete pod test --as=mario</strong>
pod "test" deleted</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Antes de prosseguir, execute o comando abaixo:</p>
<div class="literalblock">
<div class="content">
<pre><strong># lab-6.4.2</strong></pre>
</div>
</div>
</li>
<li>
<p>O usuário <code>mario</code> está tentando visualizar informações sobre os pods <code>et</code> e <code>indiana</code> criados em um novo namespace, <code>spielberg</code>. É possível? E, se sim, ambos os pods são investigáveis?</p>
<div class="paragraph">
<p>Observe as <em>roles</em> e RoleBindings criados no namespace que justificam o funcionamento dos comandos.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos tentar visualizar as informações dos pods informados. Primeiro, o pod <code>et</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get pod et --as mario</strong>
NAME   READY   STATUS    RESTARTS   AGE
et     1/1     Running   0          4m33s</pre>
</div>
</div>
<div class="paragraph">
<p>Tudo certo. E quanto ao pod <code>indiana</code>?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get pod indiana --as mario</strong>
Error from server (Forbidden): pods "indiana" is forbidden: User "mario" cannot get resource "pods" in API group "" in the namespace "spielberg"</pre>
</div>
</div>
<div class="paragraph">
<p>Ahá! Aí está o erro. Vamos ver quais roles existem dentro do namespace:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get role</strong>
NAME         CREATED AT
pod-reader   2023-05-05T02:54:59Z</pre>
</div>
</div>
<div class="paragraph">
<p>Quais seriam as permissões garantidas por essa <em>role</em>?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg describe role pod-reader</strong>
Name:         pod-reader
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  pods       []                 [et]            [get watch list]</pre>
</div>
</div>
<div class="paragraph">
<p>Note que apenas o pod <code>et</code> é afetado pela <em>role</em> acima, como indicado pela coluna <em>Resource Names</em>. Como conseguimos visualizar informações sobre o pod <code>et</code> anteriormente (mas não <code>indiana</code>), é de se imaginar que o usuário <code>mario</code> tenha <em>binding</em> sob essa <em>role</em>&#8201;&#8212;&#8201;vamos verificar.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get rolebinding</strong>
NAME               ROLE              AGE
pod-reader-mario   Role/pod-reader   5m16s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg describe rolebinding pod-reader-mario</strong>
Name:         pod-reader-mario
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  Role
  Name:  pod-reader
Subjects:
  Kind  Name   Namespace
  ----  ----   ---------
  User  mario</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Edite a <em>role</em> <code>pod-reader</code> de forma que o usuário <code>mario</code> possa investigar também o pod <code>indiana</code>. Não ofereça mais permissões que o estritamente necessário para que o usuário possa realizar essa tarefa.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos lá. Primeiro, invoque a edição da <em>role</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg edit role pod-reader</strong>
role.rbac.authorization.k8s.io/pod-reader edited</pre>
</div>
</div>
<div class="paragraph">
<p>Na seção <code>.rules.resourceNames</code>, adicione o nome do pod <code>indiana</code> ao do pod <code>et</code>, que já consta na lista de <code>resourceNames</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">resourceNames</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">et</span>
<span class="pi">-</span> <span class="s">indiana</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Agora sim, deve funcionar. Vamos ver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get pod indiana --as mario</strong>
NAME      READY   STATUS    RESTARTS   AGE
indiana   1/1     Running   0          8m49s</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>O usuário <code>mario</code> agora irá necessitar de permissões para criar, listar e deletar deployments no namespace <code>spielberg</code>. Caso você tente editar a <em>role</em> preexistente, <code>pod-reader</code>, irá notar que não é possível alterar alguns de seus parâmetros-chave, como <code>apiVersion</code>, <code>kind</code> e <code>name</code>.</p>
<div class="paragraph">
<p>Exporte a <em>role</em> <code>pod-reader</code> em formato YAML. A seguir edite o arquivo, alterando o nome da <em>role</em> para <code>deployadm-podrdr</code> e adicionando as permissões mencionadas no parágrafo anterior. Tenhas especial atenção com o atributo <code>apiGroups</code>.</p>
</div>
<div class="paragraph">
<p>Remova a <em>role</em> <code>pod-reader</code> e seu RoleBinding associado.</p>
</div>
<div class="paragraph">
<p>Finalmente, adicione via arquivo YAML a <em>role</em> <code>deployadm-podrdr</code> e crie um RoleBinding com o nome <code>deployadm-podrdr-mario</code>, associando a <em>role</em> ao usuário <code>mario</code>. Crie, liste e remova um deployment qualquer para validar sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Como a <em>role</em> deve ter seu nome alterado, iremos exportá-la e editar seu nome e permissionamento conforme solicitado. Vamos começar pela exportação:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get role pod-reader -o yaml > deployadm-podrdr.yaml</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Agora, edite seu conteúdo, que deve ficar como mostrado abaixo. Note que as seção não-relevantes para a configuração da <em>role</em> foram omitidas aqui.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">spielberg</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">deployadm-podrdr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span>
  <span class="na">resourceNames</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">et"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">indiana"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">apps"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">extensions"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">deployments"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">delete"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Excelente. Vamos remover a <em>role</em> e RoleBinding&#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg delete role pod-reader</strong>
role.rbac.authorization.k8s.io "pod-reader" deleted</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg delete rolebinding pod-reader-mario</strong>
rolebinding.rbac.authorization.k8s.io "pod-reader-mario" deleted</pre>
</div>
</div>
<div class="paragraph">
<p>E recriar a <em>role</em> via arquivo YAML.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f deployadm-podrdr.yaml</strong>
role.rbac.authorization.k8s.io/deployadm-podrdr created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg describe role deployadm-podrdr</strong>
Name:         deployadm-podrdr
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
PolicyRule:
  Resources               Non-Resource URLs  Resource Names  Verbs
  ---------               -----------------  --------------  -----
  deployments.apps        []                 []              [create delete list]
  deployments.extensions  []                 []              [create delete list]
  pods                    []                 [et]            [get watch list]
  pods                    []                 [indiana]       [get watch list]</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, refazemos a associação do usuário via RoleBinding.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg create rolebinding deployadm-podrdr-mario --role=deployadm-podrdr --user=mario</strong>
rolebinding.rbac.authorization.k8s.io/deployadm-podrdr-mario created</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, o teste. Vamos criar, listar e remover um deployment qualquer para validar nossa configuração.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg create deploy test --image=nginx:alpine --replicas=2 --as=mario</strong>
deployment.apps/test created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg get deploy --as mario</strong>
NAME   READY   UP-TO-DATE   AVAILABLE   AGE
test   2/2     2            2           16s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n spielberg delete deploy test --as mario</strong>
deployment.apps "test" deleted</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Remova o namespace <code>spielberg</code> para liberar recursos do <em>cluster</em>.</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete ns spielberg</strong>
namespace "spielberg" deleted</pre>
</div>
</div>
<div class="paragraph">
<p>Note que, ao remover o namespace, todos os recuros nele contidos (como pods, Roles e RoleBindings) também são removidos.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_papéis_cluster_wide">5) Papéis <em>cluster-wide</em></h3>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Quantos ClusterRoles e ClusterRoleBindings existem no <em>cluster</em>, no momento?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Com o uso da <em>flag</em> <code>--no-headers</code> e o comando <code>wc</code>, é trivial descobrir essas informações. Veja:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get clusterrole --no-headers | wc -l</strong>
69</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get clusterrolebinding --no-headers | wc -l</strong>
55</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Em qual namespace está inserido o ClusterRole <code>cluster-admin</code>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Como documentado em <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole" class="bare">https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole</a>, ClusterRoles são recursos <em>non-namespaced</em> (isto é, não inseridos em nenhum namespace), mas sim <em>cluster-wide</em>.</p>
</div>
<div class="paragraph">
<p>ClusterRoles podem ser utilizados para garantir acesso a:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Recursos no escopo do <em>cluster</em>, como <em>nodes</em>.</p>
</li>
<li>
<p><em>Endpoints</em> que não configuram recursos <em>per se</em>, como <code>/healthz</code>.</p>
</li>
<li>
<p>Recursos dentro do escopo de namespaces, como pods, garantindo acesso através de todos os namespaces (por exemplo, o comando <code>kubectl get pods --all-namespaces</code>).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Quais usuários ou grupos são associados ao ClusterRole <code>cluster-admin</code>? Que tipo de permissionamento esses agentes possuem sobre o <em>cluster</em>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A associação a ClusterRoles pode ser determinada através do exame de seu(s) ClusterRoleBindings correspondentes, via <code>kubectl describe</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe clusterrolebinding cluster-admin</strong>
Name:         cluster-admin
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  cluster-admin
Subjects:
  Kind   Name            Namespace
  ----   ----            ---------
  Group  system:masters</pre>
</div>
</div>
<div class="paragraph">
<p>Quais seriam essas permissões? Vamos ver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe clusterrole cluster-admin</strong>
Name:         cluster-admin
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  *.*        []                 []              [*]
             [*]                []              [*]</pre>
</div>
</div>
<div class="paragraph">
<p>Portanto, os usuário associados ao grupo <code>system:masters</code> possuem permissão total sobre todos os recursos do <em>cluster</em>.</p>
</div>
</div>
</details>
</li>
<li>
<p>O Kubernetes, como sabemos, possui diversos objetos e recursos à disposição do administrador. Utilizando o comando <code>kubectl api-groups</code>, determine quais recursos são <em>cluster-wide</em> e quais deles não o são. Exiba apenas seus nomes, em ordem alfabética.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A <em>flag</em> <code>--namespaced</code> pode ser usada para mostrar aqueles recursos que não estão associados a namespaces (isto é, <em>cluster-wide</em>). Via <code>--sort-by</code> podemos organizar a lista alfabeticamente, ainda.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl api-resources --namespaced=false --sort-by=name -o=name</strong>
apiservices.apiregistration.k8s.io
bgpconfigurations.crd.projectcalico.org
bgppeers.crd.projectcalico.org
blockaffinities.crd.projectcalico.org
caliconodestatuses.crd.projectcalico.org
certificatesigningrequests.certificates.k8s.io
clusterinformations.crd.projectcalico.org
clusterrolebindings.rbac.authorization.k8s.io
clusterroles.rbac.authorization.k8s.io
componentstatuses
csidrivers.storage.k8s.io
csinodes.storage.k8s.io
customresourcedefinitions.apiextensions.k8s.io
felixconfigurations.crd.projectcalico.org
flowschemas.flowcontrol.apiserver.k8s.io
globalnetworkpolicies.crd.projectcalico.org
globalnetworksets.crd.projectcalico.org
hostendpoints.crd.projectcalico.org
ingressclasses.networking.k8s.io
ipamblocks.crd.projectcalico.org
ipamconfigs.crd.projectcalico.org
ipamhandles.crd.projectcalico.org
ippools.crd.projectcalico.org
ipreservations.crd.projectcalico.org
kubecontrollersconfigurations.crd.projectcalico.org
mutatingwebhookconfigurations.admissionregistration.k8s.io
namespaces
nodes
nodes.metrics.k8s.io
persistentvolumes
priorityclasses.scheduling.k8s.io
prioritylevelconfigurations.flowcontrol.apiserver.k8s.io
runtimeclasses.node.k8s.io
selfsubjectaccessreviews.authorization.k8s.io
selfsubjectrulesreviews.authorization.k8s.io
storageclasses.storage.k8s.io
subjectaccessreviews.authorization.k8s.io
tokenreviews.authentication.k8s.io
validatingwebhookconfigurations.admissionregistration.k8s.io
volumeattachments.storage.k8s.io</pre>
</div>
</div>
<div class="paragraph">
<p>Alterando a <em>flag</em> <code>--namespaced</code> para <code>true</code>, descobrimos os recursos que são associados a namespaces.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl api-resources --namespaced=true --sort-by=name -o=name</strong>
bindings
configmaps
controllerrevisions.apps
cronjobs.batch
csistoragecapacities.storage.k8s.io
daemonsets.apps
deployments.apps
endpoints
endpointslices.discovery.k8s.io
events
events.events.k8s.io
horizontalpodautoscalers.autoscaling
ingresses.networking.k8s.io
jobs.batch
leases.coordination.k8s.io
limitranges
localsubjectaccessreviews.authorization.k8s.io
networkpolicies.networking.k8s.io
networkpolicies.crd.projectcalico.org
networksets.crd.projectcalico.org
persistentvolumeclaims
poddisruptionbudgets.policy
pods
pods.metrics.k8s.io
podtemplates
replicasets.apps
replicationcontrollers
resourcequotas
rolebindings.rbac.authorization.k8s.io
roles.rbac.authorization.k8s.io
secrets
serviceaccounts
services
statefulsets.apps</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>O usuário <code>mario</code> está agora responsável pelo monitoramento de <em>nodes</em> do <em>cluster</em>. Naturalmente, permissões apropriadas devem ser dadas ao usuário de forma que ele consiga realizar seu trabalho.</p>
<div class="paragraph">
<p>Primeiramente, determine as ações (<code>verbs</code>) suportadas pelo objeto-alvo (<code>nodes</code>).</p>
</div>
<div class="paragraph">
<p>A seguir, crie o ClusterRole <code>node-monitor</code> que garanta todas as permissões não-invasivas (isto é, que permitem criação, deleção ou edição de objetos) ao objeto-alvo <code>nodes</code>.</p>
</div>
<div class="paragraph">
<p>Crie, também, o ClusterRoleBinding <code>node-monitor-mario</code> que associe o ClusterRole <code>node-monitor</code> ao usuário <code>mario</code>.</p>
</div>
<div class="paragraph">
<p>Finalmente, teste o funcionamento de sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A opção <code>-o=wide</code> do comando <code>kubectl api-resources</code> permite mostrar as ações associadas a um objeto. Vamos verificar quais são essas ações para <em>nodes</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl api-resources --namespaced=false --sort-by=name -o=wide | grep ' Node ' | awk '{print $NF}'</strong>
create,delete,deletecollection,get,list,patch,update,watch</pre>
</div>
</div>
<div class="paragraph">
<p>Evidentemente, as ações <code>create</code>, <code>delete</code>, <code>deletecollection</code>, <code>patch</code> e <code>update</code> permitem ativa alteração do estado de objetos. Vamos criar a ClusterRole removendo esses <code>verbs</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create clusterrole node-monitor --resource=nodes --verb=get,list,watch</strong>
clusterrole.rbac.authorization.k8s.io/node-monitor created</pre>
</div>
</div>
<div class="paragraph">
<p>Verifiquemos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe clusterrole node-monitor</strong>
Name:         node-monitor
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  nodes      []                 []              [get list watch]</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, ao ClusterRoleBinding:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create clusterrolebinding node-monitor-mario --clusterrole=node-monitor --user=mario</strong>
clusterrolebinding.rbac.authorization.k8s.io/node-monitor-mario created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe clusterrolebinding node-monitor-mario</strong>
Name:         node-monitor-mario
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  node-monitor
Subjects:
  Kind  Name   Namespace
  ----  ----   ---------
  User  mario</pre>
</div>
</div>
<div class="paragraph">
<p>Via <code>kubectl auth</code>, testemos se o usuário possui permissão para realizar as ações adicionadas ao ClusterRole.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl auth can-i list nodes --as mario</strong>
Warning: resource 'nodes' is not namespace scoped
yes</pre>
</div>
</div>
<div class="paragraph">
<p>E, claro, vamos verificar também com o comando "ao vivo":</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get nodes --as mario</strong>
NAME          STATUS   ROLES           AGE   VERSION
s2-master-1   Ready    control-plane   47h   v1.27.1
s2-node-1     Ready    &lt;none&gt;          46h   v1.27.1</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>O usuário <code>mario</code> também ficará responsável pela gestão de armazenamento do <em>cluster</em>, incluindo criação, remoção e quaisquer outras ações sobre objetos relacionados ao <code>apiGroup</code> <code>storage.k8s.io</code>.</p>
<div class="paragraph">
<p>Além desses objetos, as mesmas permissões deverão ser garantidas a PersistentVolumes, discutidos em maior detalhe no capítulo dedicado à gestão de armazenamento no Kubernetes.</p>
</div>
<div class="paragraph">
<p>Crie, via arquivos YAML, o ClusterRole e ClusterRoleBinding que atingem os objetivos acima. A seguir, teste sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiro, determine quais recursos <em>cluster-wide</em> pertencem ao <code>apiGroup</code> em questão.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl api-resources --namespaced=false | grep 'storage.k8s.io'</strong>
csidrivers                                     storage.k8s.io/v1                      false        CSIDriver
csinodes                                       storage.k8s.io/v1                      false        CSINode
storageclasses                    sc           storage.k8s.io/v1                      false        StorageClass
volumeattachments                              storage.k8s.io/v1                      false        VolumeAttachment</pre>
</div>
</div>
<div class="paragraph">
<p>Além desses, temos também o recurso <code>PersistentVolume</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl api-resources --namespaced=false | grep ' PersistentVolume$'</strong>
persistentvolumes                 pv           v1                                     false        PersistentVolume</pre>
</div>
</div>
<div class="paragraph">
<p>Edite o arquivo YAML que descreve o ClusterRole objetivado, com o conteúdo que se segue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">storage-admin</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">persistentvolumes"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">storage.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, crie o ClusterRole via <code>kubectl create</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create -f storage-admin.yaml</strong>
clusterrole.rbac.authorization.k8s.io/storage-admin created</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, para o ClusterRoleBinding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">storage-admin-mario</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">storage-admin</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mario</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create -f storage-admin-mario.yaml</strong>
clusterrolebinding.rbac.authorization.k8s.io/storage-admin-mario created</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos testar! Execute alguma ação sobre os objetos delineados no ClusterRole&#8201;&#8212;&#8201;por exemplo, <code>csinodes</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get csinodes --as mario</strong>
NAME          DRIVERS   AGE
s2-master-1   0         47h
s2-node-1     0         46h</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Antes de continuar, para manter a integridade do <em>cluster</em>, remova todos os elementos criados durante os passos (e) e (f) desta atividade.</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete clusterrole node-monitor               ; \
  kubectl delete clusterrolebinding node-monitor-mario  ; \
  kubectl delete clusterrole storage-admin              ; \
  kubectl delete clusterrolebinding storage-admin-mario</strong>
clusterrole.rbac.authorization.k8s.io "node-monitor" deleted
clusterrolebinding.rbac.authorization.k8s.io "node-monitor-mario" deleted
clusterrole.rbac.authorization.k8s.io "storage-admin" deleted
clusterrolebinding.rbac.authorization.k8s.io "storage-admin-mario" deleted</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_segurança_de_imagens">6) Segurança de imagens</h3>

</div>
<div class="sect2">
<h3 id="_6_1_deployment_de_registry_privado">6.1) Deployment de <em>registry</em> privado</h3>
<div class="paragraph">
<p>O uso de um <em>registry</em> privado permite à uma organização manter suas imagens de container em um ambiente seguro e controlado. Através de um <em>registry</em> privado é possível ter maior controle sobre a gestão, permissionamento e backup de imagens produzidas para uso interno.</p>
</div>
<div class="paragraph">
<p>Vamos, nesta atividade, fazer o deployment de um <em>registry</em> privado usando a imagem <a href="https://hub.docker.com/_/registry" class="bare">https://hub.docker.com/_/registry</a> . Adicionalmente, iremos configurar criptografia TLS e autenticação para maior segurança no uso do ambiente.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Garanta que você está logado na máquina <code>s2-master-1</code>, como o usuário <code>root</code>.</p>
<div class="literalblock">
<div class="content">
<pre><strong># hostname ; whoami</strong>
s2-master-1
root</pre>
</div>
</div>
</li>
<li>
<p>Crie um diretório de trabalho onde os artefatos do <em>registry</em> privado serão criados. A seguir, entre nesse diretório.</p>
<div class="literalblock">
<div class="content">
<pre><strong># mkdir -p ~/registry/{images,certs,auth}</strong></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># cd ~/registry</strong></pre>
</div>
</div>
</li>
<li>
<p>Vamos, agora, criar o par de chaves assimétricas usados para conexão TLS com o <em>registry</em> privado. Note a configuração do <em>hostname</em> do <em>registry</em> no comando abaixo, <code>registry.contorq.com</code>:</p>
<div class="literalblock">
<div class="content">
<pre><strong># openssl req \
  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \
  -subj "/C=BR/ST=DF/L=Brasilia/O=Contorq/OU=IT/CN=registry.contorq.com" \
  -x509 -days 365 -out certs/domain.crt \
  -extensions EXT -config <( \
   printf "[dn]\nCN=registry.contorq.com\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:registry.contorq.com\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth")</strong></pre>
</div>
</div>
</li>
<li>
<p>Para que <em>daemon</em> Docker possa operar com um <em>registry</em> utilizando um certificado auto-assinado (como o criado no passo anterior) é necessário copiar sua chave pública para o diretório <code>/etc/docker/certs.d</code>. Vamos fazer isso para o <em>host</em> <code>s2-master-1</code>:</p>
<div class="literalblock">
<div class="content">
<pre><strong># mkdir -p /etc/docker/certs.d/registry.contorq.com:30500</strong></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># cp certs/domain.crt /etc/docker/certs.d/registry.contorq.com:30500/ca.crt</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Como o serviço será acessado por nome e fora do contexto do Kubernetes (via <em>daemon</em> Docker, de fato), vamos configurar o <em>hostname</em> <code>registry.contorq.com</code> estaticamente via arquivo <code>/etc/hosts</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># echo '192.168.68.20 registry.contorq.com' >> /etc/hosts</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Os mesmos passos devem ser realizados para o <em>host</em> <code>s2-node-1</code>. Vamos lá:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># sudo -u vagrant scp -i /home/vagrant/.ssh/tmpkey certs/domain.crt vagrant@s2-node-1:~/ca.crt</strong>
domain.crt                                                          100% 2041   519.8KB/s   00:00</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># sudo -u vagrant ssh -i /home/vagrant/.ssh/tmpkey s2-node-1 /bin/bash << EOF
sudo mkdir -p /etc/docker/certs.d/registry.contorq.com:30500
sudo mv /home/vagrant/ca.crt /etc/docker/certs.d/registry.contorq.com:30500
sudo bash -c 'cat << EOS >> /etc/hosts
192.168.68.20 registry.contorq.com
EOS'
EOF</strong></pre>
</div>
</div>
</li>
<li>
<p>Iremos utilizar autenticação HTTP <code>BASIC</code> para validar acesso ao <em>registry</em> privado&#8201;&#8212;&#8201;de fato, via arquivo <code>.htpasswd</code>. Vamos criar um arquivo com um único usuário <code>stanley</code>, com senha igual a <code>swordfish</code>:</p>
<div class="literalblock">
<div class="content">
<pre><strong># apt install -y apache2-utils &&
  htpasswd -Bbn stanley swordfish > auth/htpasswd</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Verique seu conteúdo antes de prosseguir:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># cat auth/htpasswd</strong>
stanley:$2y$05$.zeHA1z2hxhv6kUoeIcKOee/oQrQ7mBr34TAhQ.TE5wPSIGx4MPR6</pre>
</div>
</div>
</li>
<li>
<p>Tudo pronto! Vamos fazer o deployment da aplicação seguindo as instruções em <a href="https://docs.docker.com/registry/deploying/" class="bare">https://docs.docker.com/registry/deploying/</a> , fazendo adaptações para um ambiente Kubernetes (e não Docker, puramente).</p>
<div class="paragraph">
<p>Crie o arquivo <code>/root/registry/registry.yaml</code> com o conteúdo que se segue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">registry</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">registry</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">registry</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">registry</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeName</span><span class="pi">:</span> <span class="s">s2-master-1</span>
      <span class="na">tolerations</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">node-role.kubernetes.io/master"</span>
        <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
        <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoSchedule"</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">registry:2.8.1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">registry</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_AUTH</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">htpasswd"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_AUTH_HTPASSWD_REALM</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Contorq</span><span class="nv"> </span><span class="s">Registry"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_AUTH_HTPASSWD_PATH</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/auth/htpasswd</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_HTTP_TLS_CERTIFICATE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/certs/domain.crt</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_HTTP_TLS_KEY</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/certs/domain.key</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">registry-port</span>
          <span class="na">containerPort</span><span class="pi">:</span> <span class="m">5000</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">auth</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/auth</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">certs</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/certs</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">images</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/registry</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">auth</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/root/registry/auth</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">certs</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/root/registry/certs</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">images</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/root/registry/images</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">registry</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">5000</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">5000</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30500</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">registry</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, faça o deployment via <code>kubectl apply</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f registry.yaml</strong>
deployment.apps/registry created
service/registry created</pre>
</div>
</div>
</li>
<li>
<p>Verifique se o deployment funcionou a contento:</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get deployment registry</strong>
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
registry   1/1     1            1           29m</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get svc registry</strong>
NAME       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
registry   NodePort   10.111.173.190   &lt;none&gt;        5000:30500/TCP   30m</pre>
</div>
</div>
<div class="paragraph">
<p>Observe que, devido ao uso do atributo <code>nodeName</code> e à tolerância aplicada ao container, o pod <code>registry</code> está executando no <em>node</em> <code>s2-master-1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get pod -l app=registry -o custom-columns=NAME:.metadata.name,NODE:.spec.nodeName</strong>
NAME                        NODE
registry-69b58fcf58-g9vs6   s2-master-1</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_2_fazendo_o_upload_de_imagens_para_um_registry_privado">6.2) Fazendo o upload de imagens para um <em>registry</em> privado</h3>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Antes de utilizar o <em>registry</em> para criar pods e deployments devemos, evidentemente, fazer o upload de imagens para esse <em>registry</em>.</p>
<div class="paragraph">
<p>Primeiro, garanta que você está logado na máquina <code>s2-master-1</code>, como o usuário <code>root</code>. Usando o comando <code>docker</code>, faça o download da imagem <code>fbscarel/myapp-color</code> (não execute um container, apenas realize o download).</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos garantir que estamos na máquina, e com o usuário correto:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># hostname ; whoami</strong>
s2-master-1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Para fazer o download da imagem, executamos <code>docker pull</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># docker pull fbscarel/myapp-color</strong>
Using default tag: latest
latest: Pulling from fbscarel/myapp-color

(...)

Status: Downloaded newer image for fbscarel/myapp-color:latest
docker.io/fbscarel/myapp-color:latest</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Usando o comando <code>docker</code>, aplique uma <em>tag</em> à imagem recém-baixada, utilizando o <em>registry</em> privado <code>registry.contorq.com:30500</code>.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="literalblock">
<div class="content">
<pre><strong># docker tag fbscarel/myapp-color:latest registry.contorq.com:30500/myapp-color</strong></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Usando o comando <code>docker</code>, realize o login no <em>registry</em> privado. Atente-se ao usuário e senha configurados durante a atividade anterior.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="literalblock">
<div class="content">
<pre><strong># docker login registry.contorq.com:30500</strong>
Username: <strong>stanley</strong>
Password: <strong>swordfish</strong>

(...)

Login Succeeded</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Faça o upload da imagem cuja <em>tag</em> foi aplicada no passo (b) para o <em>registry</em> privado.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="literalblock">
<div class="content">
<pre><strong># docker push registry.contorq.com:30500/myapp-color</strong>
The push refers to repository [registry.contorq.com:30500/myapp-color]

(...)

sha256:0e8179db14378826d62d1934fe56d23f78d3f4c18cd97ae1642cb56eb553bf23 size: 1788</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Verifique que a imagem foi recebida com sucesso, usando o comando <code>curl</code> para consultar o catálogo do <em>registry</em>. Sugestão: verifique a funcionalidade das <em>flags</em> <code>--insecure</code> e <code>--user</code>.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Basta utilizar as <em>flags</em> informadas da seguinte forma, ao invocar o <code>curl</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># curl --insecure -u stanley:swordfish https://registry.contorq.com:30500/v2/_catalog</strong>
{"repositories":["myapp-color"]}</pre>
</div>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_3_utilizando_um_registry_privado">6.3) Utilizando um <em>registry</em> privado</h3>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Crie um deployment com o nome <code>private-app</code> e 2 réplicas utilizando a imagem armazenada no <em>registry</em> privado durante a atividade anterior.</p>
<div class="paragraph">
<p>Verifique o estado dos pods, e determine: a aplicação está operacional?</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiro, vamos criar o deployment:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create deploy private-app --image=registry.contorq.com:30500/myapp-color --replicas=2</strong>
deployment.apps/private-app created</pre>
</div>
</div>
<div class="paragraph">
<p>Qual seria o estado dos pods? Chequemos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe pod -l app=private-app | tail -n5</strong>
  Normal   Pulling    27s (x3 over 69s)  kubelet            Pulling image "registry.contorq.com:30500/myapp-color"
  Warning  Failed     27s (x3 over 69s)  kubelet            Failed to pull image "registry.contorq.com:30500/myapp-color": rpc error: code = Unknown desc = Error response from daemon: Get <a href="https://registry.contorq.com:30500/v2/myapp-color/manifests/latest" class="bare">https://registry.contorq.com:30500/v2/myapp-color/manifests/latest</a>: no basic auth credentials
  Warning  Failed     27s (x3 over 69s)  kubelet            Error: ErrImagePull
  Normal   BackOff    1s (x4 over 69s)   kubelet            Back-off pulling image "registry.contorq.com:30500/myapp-color"
  Warning  Failed     1s (x4 over 69s)   kubelet            Error: ImagePullBackOff</pre>
</div>
</div>
<div class="paragraph">
<p>Não deu certo&#8230;&#8203; ao verificar a razão, fica claro o motivo: não existem credenciais de acesso informadas para conexão com o <em>registry</em> privado <code>registry.contorq.com</code>. Vamos corrigir isso.</p>
</div>
</div>
</details>
</li>
<li>
<p>Crie um objeto do tipo Secret, <code>registry-secret</code>, contendo as credenciais requetidas para acessar o <em>registry</em> privado. Verifique o funcionamento de sua configuração.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Note que o tipo do Secret deve ser <code>docker-registry</code>, como no comando mostrado abaixo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create secret docker-registry registry-secret --docker-server=https://registry.contorq.com:30500 --docker-username=stanley --docker-password=swordfish</strong>
secret/registry-secret created</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique seu conteúdo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe secrets registry-secret</strong>
Name:         registry-secret
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  kubernetes.io/dockerconfigjson

Data
===
.dockerconfigjson:  128 bytes</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Edite o deployment <code>private-app</code> e configure-o para utilizar as credenciais de login do <em>registry</em> privado <code>registry.contorq.com:30500</code>.</p>
<div class="paragraph">
<p>A seguir, verifique que os pods do deployment estão operacionais. Caso afirmativo, crie um serviço do tipo <code>NodePort</code> que exponha a aplicação e verifique seu funcionamento usando os comandos <code>curl</code> ou <code>wget</code>.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Invoque a edição do deployment:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl edit deploy private-app</strong>
deployment.apps/private-app edited</pre>
</div>
</div>
<div class="paragraph">
<p>Na seção <code>.spec.template.spec.imagePullSecrets</code>, insira o nome do Secret criado anteriormente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">imagePullSecrets</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">registry-secret</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Imediatamente, o deployment é atualizado e seus pods, recriados. Em pouco tempo, eles ficam operacionais:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl get deploy private-app</strong>
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
private-app   2/2     2            2           11m</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl describe pod -l app=private-app | tail -n4</strong>
  Normal  Pulled     15s   kubelet            Successfully pulled image "registry.contorq.com:30500/myapp-color" in 79.560448ms (79.564714ms including waiting)
  Normal  Created    51s   kubelet            Created container myapp-color
  Normal  Started    51s   kubelet            Started container myapp-color
  Normal  Scheduled  12s   default-scheduler  Successfully assigned default/private-app-86856f988f-fc88b to s2-node-1</pre>
</div>
</div>
<div class="paragraph">
<p>Para testar o deployment, basta criar o serviço do tipo <code>NodePort</code> e usar o <code>curl</code> para acessá-lo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create svc nodeport private-app --tcp 80 --node-port=30080</strong>
service/private-app created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># curl http://localhost:30080/color</strong>
Hostname: private-app-f4486fb8d-lfnlg ; Color: blue</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Antes de prosseguir, remova os objetos criados durante essas atividades, de forma a reduzir o uso de recursos do <em>cluster</em>.</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete pod,rs,deploy --all         ; \
  kubectl delete svc -l provider!=kubernetes ; \
  kubectl delete secret registry-secret</strong>
pod "private-app-f4486fb8d-fnfz4" deleted
pod "private-app-f4486fb8d-lfnlg" deleted

(...)

service "registry" deleted
secret "registry-secret" deleted</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_contextos_de_segurança">7) Contextos de segurança</h3>

</div>
<div class="sect2">
<h3 id="_7_1_alterando_usuário_e_grupo_efetivos">7.1) Alterando usuário e grupo efetivos</h3>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Crie o pod <code>aurora</code> com a imagem <code>busybox</code>, executando o comando <code>sleep 600</code>. Feito isso, responda: qual é o usuário utilizado para rodar esse processo?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Criar o pod é bastante fácil:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl run aurora --image=busybox -- sleep 600</strong>
pod/aurora created</pre>
</div>
</div>
<div class="paragraph">
<p>Para verificar o usuário executando o comando, podemos usar o <code>ps</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it aurora -- ps auxmw | grep [s]leep</strong>
    1 root      0:00 sleep 600</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Edite as configurações do pod, de forma que o processo execute com o <em>user ID</em> 1000. O que ocorre?</p>
<div class="paragraph">
<p>Em caso de erro, exporte e edite a configuração do pod, e em seguida recrie-o.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Ao tentar editar o pod, encontramos um erro, como já aconteceu em outras atividades.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl edit pod aurora</strong></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># pods "aurora" was not valid:
# * spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`, `spec.initContainers[*].image`, `spec.activeDeadlineSeconds` or `spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos recriar o pod via arquivo YAML. Use o conteúdo abaixo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aurora</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">securityContext</span><span class="pi">:</span>
    <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">1000</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sleep</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">600"</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">aurora</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Em um <em>one-liner</em>, removemos o pod e o recriamos via YAML.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete pod aurora ; kubectl create -f aurora.yaml</strong>
pod "aurora" deleted
pod/aurora created</pre>
</div>
</div>
<div class="paragraph">
<p>Ao verificar o usuário que invocou o comando <code>sleep</code>, fica claro que a configuração surtiu o efeito esperado.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it aurora -- ps auxmw | grep [s]leep</strong>
    1 1000      0:00 sleep 600</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Por que o <em>user ID</em> do processo é mostrado em formato numérico?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Para verificar os usuários mapeados no sistema podemos consultar o arquivo <code>/etc/passwd</code>. Note que nenhum dos usuários nesse arquivo possui o UID 1000.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it aurora -- cat /etc/passwd</strong>
root:x:0:0:root:/root:/bin/sh
daemon:x:1:1:daemon:/usr/sbin:/bin/false
bin:x:2:2:bin:/bin:/bin/false
sys:x:3:3:sys:/dev:/bin/false
sync:x:4:100:sync:/bin:/bin/sync
mail:x:8:8:mail:/var/spool/mail:/bin/false
www-data:x:33:33:www-data:/var/www:/bin/false
operator:x:37:37:Operator:/var:/bin/false
nobody:x:65534:65534:nobody:/home:/bin/false</pre>
</div>
</div>
<div class="paragraph">
<p>De fato, do ponto de vista do pod, é como se esse usuário "não existisse":</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it aurora -- whoami</strong>
whoami: unknown uid 1000</pre>
</div>
</div>
<div class="paragraph">
<p>Mas, de fato, há um usuário com esse UID dentro do <em>host</em>: o <code>vagrant</code>, como verificado pelo comando abaixo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># getent passwd vagrant</strong>
vagrant:x:1000:1000:vagrant,,,:/home/vagrant:/bin/bash</pre>
</div>
</div>
<div class="paragraph">
<p>O mapeamento de UIDs e execução de pods não-privilegiados é um tema complexo, que pode ser tratado de diferentes formas. A distribuição Kubernetes OpenShift, da Red Hat, possui uma abordagem interessante para o problema: o uso de UIDs aleatórios e arbitrariamente assinalados. Este artigo (<a href="https://access.redhat.com/articles/4859371" class="bare">https://access.redhat.com/articles/4859371</a>) é bastante interessante, e provê informações úteis também para instalações "puras" do Kubernetes.</p>
</div>
</div>
</details>
</li>
<li>
<p>Será possível executar dois containers em um mesmo pod com usuários diferentes? Vamos testar.</p>
<div class="paragraph">
<p>Crie um multi-container pod <code>sleepers</code> com dois containers, <code>slp1</code> e <code>slp2</code>. Ambos devem usar a imagem <code>busybox</code> e executar o comando <code>sleep 600</code>. Faça com que o <em>user ID</em> padrão (i.e., aplicável a todos os containers do pod) seja 2000. Para um dos containers, altere o <em>user ID</em> para 3000.</p>
</div>
<div class="paragraph">
<p>Valide o funcionamento de sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A criação do multi-container pod em si é relativamente simples. É importante notar, porém, que o atributo <code>securityContext</code> pode ser aplicado tanto na seção <code>.spec</code> quanto <code>.spec.containers</code>&#8201;&#8212;&#8201;e, ainda, que a hierarquia dessas diretivas é respeitada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sleepers</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">securityContext</span><span class="pi">:</span>
    <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">2000</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span>  <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">slp1</span>
     <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sleep"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">600"</span><span class="pi">]</span>
     <span class="na">securityContext</span><span class="pi">:</span>
      <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">3000</span>

  <span class="pi">-</span>  <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">slp2</span>
     <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sleep"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">600"</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos criar o pod e verificar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl create -f sleepers.yaml</strong>
pod/sleepers created</pre>
</div>
</div>
<div class="paragraph">
<p>Note que, no caso do container <code>slp1</code>, o UID utilizado é o 3000&#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it sleepers -c slp1 -- ps auxmw | grep '[s]leep'</strong>
    1 3000      0:00 sleep 600</pre>
</div>
</div>
<div class="paragraph">
<p>Já no caso do container <code>slp2</code>, ele é o 2000.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it sleepers -c slp2 -- ps auxmw | grep '[s]leep'</strong>
    1 2000      0:00 sleep 600</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Qual é o grupo efetivo dos containers do pod criado no passo anterior? Ele é o mesmo para ambos?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>O grupo efetivo pode ser determinado com o comando <code>id -g</code>. Veja:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it sleepers -c slp1 -- id -g</strong>
0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it sleepers -c slp2 -- id -g</strong>
0</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Vamos resolver isso: crie o pod <code>slpgroup</code> usando a imagem <code>busybox</code>, e executando o comando <code>sleep 600</code>. Faça com que o usuário efetivo desse pod seja 1000, e que ele opere com o grupo primário 1000 e grupos suplementares 1001 e 1002.</p>
<div class="paragraph">
<p>Valide o funcionamento de sua configuração.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Para atingir os objetivos delineados basta usar os atributos <code>runAsGroup</code> e <code>supplementalGroups</code>, da seguinte forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">slpgroup</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">securityContext</span><span class="pi">:</span>
    <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">1000</span>
    <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">1000</span>
    <span class="na">supplementalGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1001</span><span class="pi">,</span> <span class="nv">1002</span><span class="pi">]</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span>  <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">slpgroup</span>
     <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sleep"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">600"</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, cria-se o pod:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f slpgroup.yaml</strong>
pod/slpgroup created</pre>
</div>
</div>
<div class="paragraph">
<p>E com o comando <code>id</code>, verificamos o funcionamento da configuração.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it slpgroup -- id</strong>
uid=1000 gid=1000 groups=1001,1002</pre>
</div>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_2_habilitando_capabilities">7.2) Habilitando <em>capabilities</em></h3>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Tente alterar a data e hora correntes do pod <code>aurora</code> para 21 de outubro de 2015, às 7:28 da manhã. O que ocorre?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A operação não é autorizada. Veja:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it aurora -- date -s '2015-10-21 07:08'</strong>
date: can't set date: Operation not permitted</pre>
</div>
</div>
<div class="paragraph">
<p>Para fazer isso, necessitamos da <em>capability</em> <code>CAP_SYS_TIME</code> adicionada ao container.</p>
</div>
</div>
</details>
</li>
<li>
<p>Adicione a <em>capability</em> <code>SYS_TIME</code> ao pod. Recrie-o se necessário.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Basta utilizar um arquivo YAML com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aurora</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sleep</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">600"</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">aurora</span>
    <span class="na">securityContext</span><span class="pi">:</span>
      <span class="na">capabilities</span><span class="pi">:</span>
        <span class="na">add</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">SYS_TIME"</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete pod aurora ; kubectl create -f aurora.yaml</strong>
pod "aurora" deleted
pod/aurora created</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Tente novamente alterar a data com o comando utilizado no passo (a) desta atividade.</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos ver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl exec -it aurora -- date -s '2015-10-21 07:08'</strong>
Wed Oct 21 07:08:00 UTC 2015</pre>
</div>
</div>
<div class="paragraph">
<p>A data é efetivamente alterada. Muito bom!</p>
</div>
</div>
</details>
</li>
<li>
<p>A lista de <em>capabilities</em> disponíveis em um sistema Linux é bastante extensa. Qual recurso pode ser consultado para visualizar a lista completa, bem como explicações sobre cada um desses <em>capabilities</em>?</p>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Além da consulta de recursos na Internet, é também possível visualizar a lista completa de <em>capabilities</em> acessando a página de manual:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># man 7 capabilities</strong></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Antes de prosseguir, remova os objetos criados durante esta atividade, de forma a reduzir o uso de recursos do <em>cluster</em>.</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete pod --all</strong>
pod "aurora" deleted
pod "sleepers" deleted
pod "slpgroup" deleted</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_8_políticas_de_rede">8) Políticas de rede</h3>
<div class="paragraph">
<p><em>Network Policies</em>, ou políticas de rede, são construtos que permitem controlar com quais entidades de rede um pod poderá (ou não) comunicar-se. Por "entidades" nos referimos a outros pods, namespaces com o qual o pod pode conversar ou faixas de endereçamento IP.</p>
</div>
<div class="paragraph">
<p>Nesta atividade iremos fazer o deployment de uma aplicação típica, com a seguinte topologia:</p>
</div>
<div id="img-s6-img1" class="imageblock text-center">
<div class="content">
<img src="./img/s6-img1.png" alt="s6 img1">
</div>
<div class="title">Figura 1. Topologia da aplicação</div>
</div>
<div class="paragraph">
<p>Note que a aplicação possui um caminho esperado de comunicação:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>O pod <code>frontend</code> deve receber requisições vindas de qualquer origem, através do serviço do tipo <code>NodePort</code> <code>frontend-svc</code>, expondo a porta 80 do pod e a porta 30080 dos <em>nodes</em>.</p>
<div class="paragraph">
<p>O pod <code>frontend</code> deve, ainda, poder comunicar-se com o pod <code>backend</code>, descrito abaixo.</p>
</div>
</li>
<li>
<p>O pod <code>backend</code> deve receber requisições vindas do pod <code>frontend</code>, através do serviço do tipo <code>ClusterIP</code> <code>backend-svc</code>, expondo a porta 80 do pod.</p>
<div class="paragraph">
<p>O pod <code>backend</code> deve, ainda, poder comunicar-se com o pod <code>db</code>, descrito abaixo.</p>
</div>
</li>
<li>
<p>O pod <code>db</code> deve receber requisições vindas do pod <code>backend</code>, através do serviço do tipo <code>ClusterIP</code> <code>db-svc</code>, expondo a porta 3306 do pod e a mesma porta, externamente.</p>
</li>
<li>
<p>Todas as demais vias de comunicação não devem ser autorizadas; isso será garantido através da implementação de <em>Network Policies</em>. Note que iremos também criar um pod não-relacionado à aplicação, <code>other-pod</code>, para validar que as políticas estão funcionando como esperado.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>O pod <code>db</code> deve utilizar a imagem <code>mysql:5.6</code>, com senha de acesso à base para o usuário <code>root</code> configurada como <code>password</code>. Todos os demais pods deverão utilizar a imagem <code>nginx:alpine</code>.</p>
</div>
<div class="paragraph">
<p>Todos os objetos acima mencionados devem ser criados em um namespace dedicado, com o nome <code>myapp</code>.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Vamos começar do princípio: crie todos os pods e serviços descritos acima, via comandos imperativos ou arquivos YAML (como preferir).</p>
<div class="paragraph">
<p>Não se preocupe com as <em>Network Policies</em> ainda: elas serão implementas nos passos a seguir.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Pode-se utilizar um único arquivo YAML para criar todos os objetos especificados no enunciado. Para isso, utilizamos o divisor <code>---</code>, que indica o começo de um novo documento YAML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
</pre></td><td class="code"><pre><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">frontend</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">backend</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">db</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">db</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">password</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:5.6</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">db</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">other-pod</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">other-pod</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">other-pod</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">frontend-svc</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">frontend-svc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30080</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-svc</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-svc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">db-svc</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">db-svc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">3306</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">3306</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">db</span>
<span class="nn">---</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ao invocar a criação, note que todos os objetos são criados em sequência.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f app-topology.yaml</strong>
namespace/myapp created
pod/frontend created
pod/backend created
pod/db created
pod/other-pod created
service/frontend-svc created
service/backend-svc created
service/db-svc created</pre>
</div>
</div>
<div class="paragraph">
<p>Podemos verificar a criação dos pods e serviços, para garantir seu funcionamento.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp get pod</strong>
NAME        READY   STATUS    RESTARTS   AGE
backend     1/1     Running   0          41s
db          1/1     Running   0          41s
frontend    1/1     Running   0          41s
other-pod   1/1     Running   0          41s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp get svc</strong>
NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
backend-svc    ClusterIP   10.109.223.133   &lt;none&gt;        80/TCP       55s
db-svc         ClusterIP   10.102.249.150   &lt;none&gt;        3306/TCP       55s
frontend-svc   NodePort    10.104.180.205   &lt;none&gt;        80:30080/TCP   55s</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Teste a conectividade entre os pods; no momento, como não há nenhuma <em>Network Policy</em> implementada, não haverá qualquer restrição de comunicação entre eles.</p>
<div class="paragraph">
<p>Como o teste de conectividade envolve verificar o acesso à uma porta TCP específica, e não simplesmente acessibilidade ao pod via pacotes ICMP (como os enviados pelo comando <code>ping</code>, por exemplo) temos que usar uma ferramenta apropriada para esse cenário.</p>
</div>
<div class="paragraph">
<p>O <code>netcat</code>, ou <code>nc</code>, é ideal para essas situações&#8201;&#8212;&#8201;e, ainda melhor, está disponível na imagem <code>nginx:alpine</code>. Pesquise como utilizar o <code>nc</code> para validar a conectividade entre <em>hosts</em>: tenha especial atenção às opções <code>-w</code> (que define o número de segundos até o <em>timeout</em> da conexão) e <code>-z</code> (<em>zero I/O mode</em>, que apenas verifica conectividade, encerrando em seguida).</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos acessar um dos pods interativamente; por exemplo, <code>other-pod</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it other-pod -- /bin/sh</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Dento dele, verificamos seu <em>hostname</em> e usuário efetivo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong>/ # hostname ; whoami</strong>
other-pod
root</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, utilizamos o <code>nc</code> para nos conectarmos a um dos serviços publicados pelos demais pods; por exemplo, <code>db-svc</code>. Note que iremos utilizar o valor de retorno do comando em um bloco <code>if</code> para definir se houve sucesso ou falha na conexão. Ao utilizarmos a porta correta, 3306, obtemos sucesso:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong>/ # if nc -w1 -z db-svc 3306; then echo "success"; else echo "failure"; fi</strong>
success</pre>
</div>
</div>
<div class="paragraph">
<p>E com uma porta incorreta, 3307, falha:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong>/ # if nc -w1 -z db-svc 3307; then echo "success"; else echo "failure"; fi</strong>
failure</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Com a conectividade entre pods validada, é hora de implementar as <em>Network Policies</em>. Vamos primeiramente fazer com que todo o tráfego entre pods, de saída e entrada, seja bloqueado&#8201;&#8212;&#8201;algo equivalente a uma política <em>default deny</em> em um firewall.</p>
<div class="paragraph">
<p>Crie uma política com o nome <code>deny-netpol</code> que bloqueie todo o tráfego originado e oriundo aos pods do namespace <code>myapp</code>. Faça uma exceção ao tráfego egresso para as portas TCP/53 e UDP/53, necessárias para resolução de nomes dentro do contexto do <em>cluster</em>.</p>
</div>
<div class="paragraph">
<p>A seguir, verifique se sua configuração surtiu o efeito esperado: teste se a resolução de nomes via DNS permanece funcional (via <code>nslookup</code>), e se os demais acessos são negados.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Uma política <em>default deny</em> como especificada pelo enunciado pode ser definida da seguinte forma. Note a exceção ao tráfego egresso para as portas TCP/53 e UDP/53.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">deny-netpol</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">53</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Criamos a política com <code>kubectl apply</code> (ou <code>create</code>).</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f deny-netpol.yaml</strong>
networkpolicy.networking.k8s.io/deny-netpol created</pre>
</div>
</div>
<div class="paragraph">
<p>Vejamos se a resolução de nomes permanece funcional:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it other-pod -- /bin/sh -c 'nslookup db-svc.myapp.svc.cluster.local'</strong>
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   db-svc.myapp.svc.cluster.local
Address: 10.102.249.150</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito! E quanto à conectividade?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it other-pod -- /bin/sh -c 'if nc -w1 -z db-svc 3306; then echo "success"; else echo "failure"; fi'</strong>
failure</pre>
</div>
</div>
<div class="paragraph">
<p>Diferentemente do que observamos no passo (b), agora o <code>nc</code> encontra falha ao conectar-se com o <em>host</em> <code>db</code>. Isso significa que a política está funcionando como esperado.</p>
</div>
</div>
</details>
</li>
<li>
<p>Vamos começar pela mais simples delas, a do pod <code>db</code>. Crie uma política com o nome <code>db-netpol</code> que implemente os controles de acesso delineados na topologia mostrada no início desta atividade.</p>
<div class="paragraph">
<p>Os seguintes requisitos devem ser atendidos pela política:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>O pod <code>backend</code> <strong>deve</strong> conseguir comunicar-se com o pod <code>db</code> através do serviço <code>db-svc</code>, na porta TCP/3306.</p>
</li>
<li>
<p>Os demais acessos devem ser negados.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Observe que, ainda que sua política esteja corretamente configurada, a política <em>default deny</em> <code>deny-netpol</code> implementada no passo (c) irá impedir a conectividade entre os pods <code>backend</code> e <code>db</code>. Iremos solucionar isso no próximo passo.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiro, definimos a política via arquivo YAML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">db-netpol</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">db</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">podSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">backend</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">3306</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>E em seguida criamos o objeto.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f db-netpol.yaml</strong>
networkpolicy.networking.k8s.io/db-netpol created</pre>
</div>
</div>
<div class="paragraph">
<p>Ainda não é possível testar se a configuração está correta, pelo motivos delineados no enunciado. Por ora, iremos prosseguir.</p>
</div>
</div>
</details>
</li>
<li>
<p>A seguir, vamos tratar do pod <code>backend</code>. Crie uma política com o nome <code>backend-netpol</code> que implemente os controles de acesso delineados na topologia mostrada no início desta atividade.</p>
<div class="paragraph">
<p>Os seguintes requisitos devem ser atendidos pela política:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>O pod <code>backend</code> <strong>deve</strong> conseguir comunicar-se com o pod <code>db</code> através do serviço <code>db-svc</code>, na porta TCP/3306.</p>
</li>
<li>
<p>O pod <code>frontend</code> <strong>deve</strong> conseguir comunicar-se com o pod <code>backend</code> através do serviço <code>backend-svc</code>, na porta TCP/80.</p>
</li>
<li>
<p>Os demais acessos devem ser negados.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Após a implementação da política você pode, agora sim, validar a conectividade entre os pods <code>backend</code> e <code>db</code> através da ferramenta <code>nc</code>.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Vamos à política:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-netpol</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">podSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">frontend</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">podSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">db</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">3306</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f backend-netpol.yaml</strong>
networkpolicy.networking.k8s.io/backend-netpol created</pre>
</div>
</div>
<div class="paragraph">
<p>Em tudo estando correto, o pod <code>backend</code> deve conseguir conectar-se com <code>db</code> através do serviço <code>db-svc</code>. Será esse o caso?</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it backend -- /bin/sh -c 'if nc -w1 -z db-svc 3306; then echo "success"; else echo "failure"; fi'</strong>
success</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito! Isso significa que as políticas estabelecidas nos passos (d) e (e) estão corretas.</p>
</div>
</div>
</details>
</li>
<li>
<p>Agora, o pod <code>frontend</code>. Crie uma política com o nome <code>frontend-netpol</code> que implemente os controles de acesso delineados na topologia mostrada no início desta atividade.</p>
<div class="paragraph">
<p>Os seguintes requisitos devem ser atendidos pela política:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Requisições vindas de qualquer origem <strong>devem</strong> conseguir comunicar-se com o pod <code>frontend</code> através do serviço <code>frontend-svc</code>, na porta TCP/80.</p>
</li>
<li>
<p>O pod <code>frontend</code> <strong>deve</strong> conseguir comunicar-se com o pod <code>backend</code> através do serviço <code>backend-svc</code>, na porta TCP/80.</p>
</li>
<li>
<p>Os demais acessos devem ser negados.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Após a implementação da política você deve validar a conectividade de requisições externas ao pod <code>frontend</code>, bem como entre os pods <code>frontend</code> e <code>backend</code>.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>Primeiro, criamos a política:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">frontend-netpol</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">podSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">backend</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">80</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f frontend-netpol.yaml</strong>
networkpolicy.networking.k8s.io/frontend-netpol created</pre>
</div>
</div>
<div class="paragraph">
<p>E agora, para os testes. Vamos verificar a conectividade externa com o serviço publicado pelo pod <code>frontend</code>&#8201;&#8212;&#8201;note que o comando abaixo não irá mostrar nenhuma saída, já que especificamos a <em>flag</em> <code>-s</code> (<code>--silent</code>) para o <code>curl</code> e a saída foi redirecionada para <code>/dev/null</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># curl -s http://localhost:30080 &> /dev/null</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Como saber que deu certo, então? Simples: basta verificar os logs do pod <code>frontend</code>. Note que uma requisição <code>GET /</code> foi recebida:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp logs frontend --tail=1</strong>
10.32.0.1 - - [05/May/2023:03:26:21 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/7.74.0" "-"</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, vamos testar a conectividade entre os pods <code>frontend</code> e <code>backend</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it frontend -- /bin/sh -c 'if nc -w1 -z backend-svc 80; then echo "success"; else echo "failure"; fi'</strong>
success</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito, tudo funcionando como esperado.</p>
</div>
</div>
</details>
</li>
<li>
<p>Vamos finalizar com o pod <code>other-pod</code>. Crie uma política com o nome <code>other-pod-netpol</code> que implemente os controles de acesso delineados na topologia mostrada no início desta atividade.</p>
<div class="paragraph">
<p>Como esse pod, diferentemente dos demais, não possui qualquer restrição de acesso, faça com que a política libere-o para conectar-se com qualquer outro pod.</p>
</div>
<div class="paragraph">
<p>Após a implementação da política você deve validar o funcionamento das <em>Network Policies</em> implementadas anteriormente: ou seja, ainda que o pod <code>other-pod</code> possa originar conexões para quaisquer destinos, as políticas dos pods <code>db</code>, <code>backend</code> e <code>frontend</code> devem impedi-lo de acessar seus serviços.</p>
</div>
<details>
<summary class="title">Visualizar resposta</summary>
<div class="content">
<div class="paragraph">
<p>A política do pod <code>other-pod</code> é bastante simples, quando comparada com as anteriores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">other-pod-netpol</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">other-pod</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{}</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl apply -f other-pod-netpol.yaml</strong>
networkpolicy.networking.k8s.io/other-pod-netpol created</pre>
</div>
</div>
<div class="paragraph">
<p>E agora, aos testes de conexão. Esperamos falha em todos eles, exceto com o pod <code>frontend</code> (cujo serviço deve receber conexões vindas de qualquer origem).</p>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it other-pod -- /bin/sh -c 'if nc -w1 -z db-svc 3306; then echo "success"; else echo "failure"; fi'</strong>
failure</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it other-pod -- /bin/sh -c 'if nc -w1 -z backend-svc 80; then echo "success"; else echo "failure"; fi'</strong>
failure</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl -n myapp exec -it other-pod -- /bin/sh -c 'if nc -w1 -z frontend-svc 80; then echo "success"; else echo "failure"; fi'</strong>
success</pre>
</div>
</div>
<div class="paragraph">
<p>De fato, as políticas criadas surtiram o efeito desejado.</p>
</div>
</div>
</details>
</li>
<li>
<p>Para concluir, remova o namespace <code>myapp</code> para liberar recursos do <em>cluster</em>.</p>
<div class="literalblock">
<div class="content">
<pre><strong># kubectl delete ns myapp</strong>
namespace "myapp" deleted</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Aviso"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>ENTREGA DA TAREFA</strong></p>
</div>
<div class="paragraph">
<p>Para que seja considerada entregue você deve anexar a esta atividade no AVA uma imagem (nos formatos .png ou .jpg) do terminal mostrando a saída do comando <code>curl</code> ao contatar o <em>deployment</em> <code>private-app</code>, criado via imagem <code>myapp-color</code> hospedada no <em>registry</em> privado <code>registry.contorq.com:30500</code>.</p>
</div>
<div class="paragraph">
<p>Utilize como referência a saída de comando mostrada na atividade 6.6.3 (c) deste roteiro.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Última atualização 2023-05-05 00:31:21 -0300
</div>
</div>
</body>
</html>
